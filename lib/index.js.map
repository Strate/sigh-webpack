{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"src/index.js","sourcesContent":["import Promise from 'bluebird'\nimport { log, Bacon } from 'sigh-core'\nimport {liftErrors, mapEvents} from \"sigh-core/lib/stream\"\nimport webpack from \"webpack\"\nimport ProgressPlugin from \"webpack/lib/ProgressPlugin\"\nimport getWebpackProgress from \"./webpackProgress\"\nimport {noop} from \"lodash\"\n\nfunction webpackHandler(resolve, reject) {\n  return function(err, stats) {\n    if (err) {\n      reject(err)\n    } else if (stats) {\n      let jsonStats = stats.toJson({\n        errorDetails: true\n      })\n      let strStats = stats.toString({\n        colors: true,\n        cached: true,\n        modules: false,\n        assets: false,\n        chunks: false,\n        chunkModules: false\n      })\n      console.log(strStats);\n      if (jsonStats.errors.length > 0) {\n        reject(new Error(\"webpack build error\"));\n      } else {\n        resolve(\"ok\")\n      }\n    } else {\n      reject(new Error(\"Webpack does not returns stats, something goes wrong\"))\n    }\n  }\n}\n\nlet lastWebpackPromise = {}\n\nfunction initPromise() {\n  lastWebpackPromise.promise = new Promise((resolve, reject) => {\n    lastWebpackPromise.resolve = resolve;\n    lastWebpackPromise.reject = reject;\n  })\n}\n\nlet watchingInstance\n\nfunction compileWebpack(compiler, watch) {\n  initPromise()\n  log(\"run webpack...\")\n  if (watch) {\n    let watching = compiler.watch({\n      aggregateTimeout: 300\n    }, webpackHandler(function(value) {\n      watching.startTime = new Date().getTime()\n      lastWebpackPromise.resolve(value)\n      initPromise()\n    }, function(reason) {\n      lastWebpackPromise.reject(reason)\n    }))\n  } else {\n    compiler.run(webpackHandler(function(value) {\n      lastWebpackPromise.resolve(value)\n      initPromise()\n    }, function(reason) {\n      lastWebpackPromise.reject(reason)\n    }))\n  }\n}\n\nfunction getCompiler(opts) {\n  let cache = {}; // webpack cache object\n  let webpack = opts.webpack || webpack\n  // https://gist.github.com/DatenMetzgerX/2a96ebf287b4311f4c18\n  let compiler = webpack(Object.assign({}, opts.webpackConfig, {\n    cache\n  }))\n  // compiler.inputFileSystem = makeFsFallback(inputFs, fs);\n  // compiler.outputFileSystem = outputFs\n  // compiler.resolvers.normal.fileSystem = compiler.inputFileSystem;\n  // compiler.resolvers.context.fileSystem = compiler.inputFileSystem;\n  compiler.apply(new ProgressPlugin(getWebpackProgress()));\n  return compiler\n}\n\nlet initialPhase = true;\nlet compiler\n\nexport default function(op, opts = {}) {\n  if (!compiler) {\n    compiler = getCompiler(opts)\n  }\n  return liftErrors(op.stream.flatMap(events => {\n    if (initialPhase) {\n      initialPhase = false;\n      compileWebpack(compiler, op.watch)\n    }\n    return Bacon.fromPromise(lastWebpackPromise.promise.then(() => events))\n  }))\n}\n"]}